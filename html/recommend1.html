<?php
//error_reporting(0);
include('Validaccess.php');
include('connect.php');
$flatNum=$_SESSION['flatNum'];
$userId=$_SESSION['userID'];
$major=array();
$type=array();
$university=array();
$gender=array();
  $recomajor=NULL;
  $rocuniv=NULL;
  $rectype=NULL;
  $genderratio=NULL;

if(isset($_POST['invite'])){
  $pdo=new PDO($dsn,$db_username,$db_password,$opt);
  $invitecontent="*Flat".$flatNum."invites you to be their friends.";
  $stmt=$pdo->query("insert into messagetable values(default,\"{$userId}\",\"{$invitecontent}\",default,\"{$_POST['Daily']}\",0)");
  $pdo=NULL;
}

$pdo=new PDO($dsn,$db_username,$db_password,$opt);

  foreach($pdo->query("select * from messagetable natural join usertable where usertable.flatNum=\"{$flatNum}\"") as $row){
    $type[]=$row['type'];
    $major[]=$row['major'];
    $university[]=$row['university'];
    $gender[]=$row['gender'];
  }

  $male=0;
  foreach($gender as $a){
    if($a=='Male'){
      $male=$male+1;
    }
  }
  $recomajor=array_search(max(array_count_values($major)),array_count_values($major));
  $rocuniv=array_search(max(array_count_values($university)),array_count_values($university));
  $rectype=array_search(max(array_count_values($type)),array_count_values($type));
  $genderratio=$male/count($gender);



$flats=array();
foreach($pdo->query("select * from messagetable natural join usertable")as $row){
  $flats[]=$row['flatNum'];
}

$resultlist=array();
$recoflat=NULL;
$pdo=NULL;



function getrecommend($type,$flats,$flatNum,$recomajor,$rocuniv,$rectype,$genderratio){//调用改函数即 获得推荐宿舍
  include('connect.php');
  global $htmlctnm,$htmlctngen,$htmlctnuni;
  $htmlctnm=$htmlctngen=$htmlctnuni=5;
  $pdo=new PDO($dsn,$db_username,$db_password,$opt);
  foreach(array_keys(array_count_values($flats)) as $sinflat){
    if($sinflat!=$flatNum && $sinflat!=0){
      $ctn=0;
      $thismajor=array();
      $thistype=array();
      $thisuniversity=array();
      $thisgender=array();
      foreach($pdo->query("select * from messagetable natural join usertable where usertable.flatNum=\"{$sinflat}\"") as $row){
        $thistype[]=$row['type'];
        $thismajor[]=$row['major'];
        $thisuniversity[]=$row['university'];
        $thisgender[]=$row['gender'];
      }

      $male=0;
      foreach($thisgender as $a){
        if($a=='Male'){
          $male=$male+1;
        }
      }

      $trecomajor=array_search(max(array_count_values($thismajor)),array_count_values($thismajor));
      $trocuniv=array_search(max(array_count_values($thisuniversity)),array_count_values($thisuniversity));
      $trectype=array_search(max(array_count_values($thistype)),array_count_values($thistype));
      $tgenderratio=$male/count($thisgender);
      if(strcmp($type,"genderratio")==0){
        if(abs($genderratio-$tgenderratio)<=0.2){
          $ctn=$ctn+1.5;
          $htmlctngen=$htmlctngen+15;
        }
        if(strcmp($recomajor,$trecomajor)==0){
          $ctn=$ctn+1;
          $htmlctnm=$htmlctnm+10;
        }
        if(strcmp($rectype,$trectype)==0){
          $ctn=$ctn+1;
        }
        if(strcmp($rocuniv,$trocuniv)==0){
          $ctn=$ctn+1;
          $htmlctnuni=$htmlctnuni+10;
        }
      }else if(strcmp($type,"major")==0){
        if(abs($genderratio-$tgenderratio)<=0.2){
          $ctn=$ctn+1;
            $htmlctngen=$htmlctngen+10;
        }
        if(strcmp($recomajor,$trecomajor)==0){
          $ctn=$ctn+1.5;
          $htmlctnm=$htmlctnm+15;
        }
        if(strcmp($rectype,$trectype)==0){
          $ctn=$ctn+1;
        }
        if(strcmp($rocuniv,$trocuniv)==0){
          $ctn=$ctn+1;
            $htmlctnuni=$htmlctnuni+10;
        }
      }else if(strcmp($type,"university")==0){
        if(abs($genderratio-$tgenderratio)<=0.2){
          $ctn=$ctn+1;
            $htmlctngen=$htmlctngen+10;
        }
        if(strcmp($recomajor,$trecomajor)==0){
          $ctn=$ctn+1;
            $htmlctnm=$htmlctnm+10;
        }
        if(strcmp($rectype,$trectype)==0){
          $ctn=$ctn+1;
        }
        if(strcmp($rocuniv,$trocuniv)==0){
          $ctn=$ctn+1.5;
            $htmlctnuni=$htmlctnuni+15;
        }
      }
      $resultlist[$sinflat]=$ctn;
    }
  }

$pdo=NULL;
if(count($resultlist)>0){
  arsort($resultlist);
  reset($resultlist);
  $recoflat=key($resultlist);
  echo"Flat ".$recoflat;
  echo"<form action='recommend.php' method='post' name='recommendForm'><input type='hidden' name='inviteflat' value='".$recoflat."'/><button class='inviteBt' name='invite'>Invite</button></form>";
echo"<p class='reason'>Your are same in ".$type."</p>";// 请修改此处的html代码，让invite 按钮在flat右边，切勿删除form，否则后端无法向对方宿舍放松信息
}else{
  echo"<p>no recommend flat for ".$type." yet</p>";
}
}




 ?>

 <!DOCTYPE html>
 <html lang="en">
 <style>
         [v-cloak] {
                     display: none !important;
         }
 </style>
 <head>
     <div id = "head">
         <text id="logout"> Log out</text>
         <link  rel="stylesheet" type="text/css" href="../css/recommend.css">
         <script type="text/javascript" src="../js/recommend.js"></script>
         <a href="tenantIndex.php"><img id="logoSmall" src="../images/logo.png" alt="logo"></a>
         <a href="tenantIndex.php" id="webName"><text id="title"> LivEasy </text></a>
         <a href="tenantIndex.php"><button class="navigation" id="myBillboard" name="myBillboard">My Billboard</button></a>
         <a href="maintenance.php"><button class="navigation" id="myMaintenance" name="myMaintenance">My Maintenance</button></a>
         <a href="timetable.php"><button class="navigation" id="mySchedule" name="mySchedule">My Schedule</button></a>
         <a href="finance.php"><button class="navigation" id="myAccounting" name="myAccounting">My Accounting</button></a>
     </div>
 </head>
 <body id="background">

 </body>
</html>
